<!--
  ~ The contents of this file are subject to the OpenMRS Public License
  ~ Version 1.0 (the "License"); you may not use this file except in
  ~ compliance with the License. You may obtain a copy of the License at
  ~ http//license.openmrs.org
  ~
  ~ Software distributed under the License is distributed on an "AS IS"
  ~ basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See the
  ~ License for the specific language governing rights and limitations
  ~ under the License.
  ~
  ~ Copyright (C) OpenMRS, LLC.  All Rights Reserved.
  -->



<htmlform formName="Consult"
          formUuid="b5a50e02-bc3b-4bc9-8d6f-a4decad17a97"
          formEncounterType="aa61d509-6e76-4036-a65d-7813c0c3b752"
          formVersion="1.0">

    <style type="text/css">

        #who-when-where {
            margin-bottom: 6px;
            border-bottom: 1px solid #ccc;
        }

        #who-when-where p {
            display: inline-block;
            padding-right: 20px;
        }

        #where > input[type=text] {
            display: inline-block;
        }

        .field-error {
            color: #ffc0b5;
            font-size: 1.1em;
            display: block;
        }

        .legalValue {
            background-color: white !important;
        }

        .two-columns {
            display: table;
            height: 100%;
            width: 100%;
        }

        .two-columns > div {
            display: table-cell;
            width: 50%;
        }

        .tres-columns {
            display: table;
            height: 100%;
            width: 100%;
        }

        .tres-columns > div {
            display: table-cell;
            width: 35%;
        }

        .three-columns {
            column-count: 3;
            -webkit-column-count: 3;
            -moz-column-count: 3;
        }

        .simple-form-ui input {
            min-width: 80%
        }

        form fieldset {
            min-width: 90%;
            display: block;
        }

        .encounter-summary-container #calculated-ratio {
            font-size: 1em;
            font-weight: normal;
        }

        #encounterDate input {
            min-width: 15%
        }

        div.inline-radio > * {
            display: inline;
            float: none !important;
            min-width: initial;
        }

        .light-font {
            font-family: "OpenSansLight",sans-serif;
        }

        .small {
            max-width: 10em;
            display: block;
            margin-bottom: 1em;
        }

        .small input {
            min-width: 4em;
            width: 4em;
            display: inline;
            margin-right: 0.5em;
        }

        .medium {
            max-width: 16em;
            display: block;
            margin-bottom: 1em;
        }

        .medium input {
            min-width: 8em;
            width: 8em;
            display: inline;
            margin-right: 0.5em;
        }

        .small-text {
            color: #555555;
            font-size: 90%;
            display: block;
        }

        .section-container {
            background: #F2F2F2;
            box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
            padding: 10px 5px 10px 15px;
            line-height: 1.5em; /*add this for vertical spacing between elements*/
        }

        .section-container input[type="checkbox"] {
            margin: 0px 5px; /*changed values to vertical, horizontal*/
            top:5px; /*added to offset the checkbox position to line up*/
        }

        .section-container label { /*new definition to override labels inside section-containers*/
            margin: 0px;
        }

        .question-container {
            background: #F2F2F2;
            box-shadow: 3px 3px 3px 1px rgba(0, 0, 0, 0.2);
            padding: 5px 5px 10px 15px;
            margin: 5px 0;
            line-height: 1.5em; /*add this for vertical spacing between elements*/
        }

        .question-container label {
            margin-top: 5px;
        }

       .section {
         width: 95%;
        }

        legend {
          width: auto;
          font-size: 16px;
        }

        textarea {
            width: 95%;
        }

        /* Grey out disabled checkboxes */
        input[type=checkbox][disabled] {
            filter: invert(15%);
        }

        .section-button {
            margin: 10px 0 0 24px;
        }

        #diagnosis-lookup {
            display: inline-block;
            width: 50%;
            vertical-align: top;
        }

        #encounter-diagnoses-target {
            display: inline-block;
            width: 40%;
            vertical-align: top;
        }

        #encounter-diagnoses-app {
            margin-bottom: 20px;
        }

        .ui-helper-hidden-accessible{
            display: none;
        }

        .ui-autocomplete-input{
            width: 90%;
        }

        .medication-instructions input { 
            width: 85%;
        }

    </style>

    <script>
        // I don't really understand why this assignment `$j = jq` is required, but for some
        // reason a bunch of Javascript gets included in the page that expects `$j` to exist,
        // but doesn't define `$j` itself. *shrug emoji*
        var $j = jQuery;
    </script>

    <div class="print-form-datestamps" style="display:none">
        <p><uimessage code="created_on"/>:
            <lookup complexExpression="$form.dateCreated"/>
        </p>
        <p><uimessage code="last_updated_on"/>:
            <lookup complexExpression="$form.dateChanged"/>
        </p>
        <p><uimessage code="printed_on"/>:
            <lookup complexExpression="$formGeneratedDatetime"/>
        </p>
    </div>

    <div class="hidden" id="encounter-details">
        <encounterDate default="now"/>
        <encounterProviderAndRole default="currentUser" encounterRole="4f10ad1a-ec49-48df-98c7-1391c6ac7f05"
                                          required="true"/>

    </div>

    <section id="encounter-location" sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="section-container">
            <label>
                <uimessage code="pihcore.locationRequired"/>
            </label>
            <encounterLocation default="SessionAttribute:emrContext.sessionLocationId"/>
        </div>
    </section>

    <section id="vitals" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.vitals.label">
        <div class="section-container">
            <table>
                <thead>
                    <tr>
                        <td style="font-weight:bold">
                            <uimessage code="pihcore.vitals.latest.measurement.label"/>
                        </td>
                        <td style="font-weight:bold">
                            <uimessage code="zl.date"/>
                        </td>
                        <td style="font-weight:bold">
                            <uimessage code="pihcore.vitals.latest.results.label"/>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.bloodPressure.title" />
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:SYSTOLIC BLOOD PRESSURE').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:SYSTOLIC BLOOD PRESSURE').valueNumeric.intValue()"/>
                            <lookup complexExpression="#if($fn.latestObs('PIH:SYSTOLIC BLOOD PRESSURE')) / #end" />
                            <lookup expression="fn.latestObs('PIH:DIASTOLIC BLOOD PRESSURE').valueNumeric.intValue()"/>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.o2sat.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:BLOOD OXYGEN SATURATION').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:BLOOD OXYGEN SATURATION').valueNumeric.intValue()"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:BLOOD OXYGEN SATURATION')) % #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="pihcore.lab.glucose"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:SERUM GLUCOSE').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:SERUM GLUCOSE').valueNumeric.intValue()"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:Fasting for blood glucose test')) #if($fn.latestObs('PIH:Fasting for blood glucose test').valueCoded.name != 'No') (en ayuno) #else (sin ayuno) #end #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.temperature.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:TEMPERATURE (C)').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:TEMPERATURE (C)').valueNumeric"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:TEMPERATURE (C)')) °C #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.heartRate.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:PULSE').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:PULSE').valueNumeric.intValue()"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:PULSE')) ppm #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.respiratoryRate.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:RESPIRATORY RATE').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('PIH:RESPIRATORY RATE').valueNumeric.intValue()"/>
                            <span class="light-font">
                                <lookup complexExpression="#if($fn.latestObs('PIH:RESPIRATORY RATE')) rpm #end" />
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <uimessage code="mirebalais.vitals.complaint.title"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('CIEL:160531').obsDatetime"/>
                        </td>
                        <td>
                            <lookup expression="fn.latestObs('CIEL:160531').valueText"/>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </section>

    <div class="hidden" id="logos" style="width=100%">
        <!-- These should appear in printed notes and prescriptions -->
        <img src="/openmrs/ms/uiframework/resource/file/configuration/pih/images/ces-logo.png" style="width: 20%; margin: 3% 5%;"/>
        <img src="/openmrs/ms/uiframework/resource/file/configuration/pih/images/ssa-fed-logo.jpg" style="width: 20%; margin: 0 5%;" />
        <img src="/openmrs/ms/uiframework/resource/file/configuration/pih/images/ssa-logo.png" style="width: 20%; margin: 0 5%;"/>
    </div>



    <section id="context" sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="section-container">
            <label>
                Referido por:
            </label>
            <obs conceptId="PIH:6189" id="referredBy"
                 answerConceptIds="PIH:12611,PIH:12612,PIH:12613,CIEL:1555"
                 answerLabels="Cita,Paciente ambulatorio,Búsqueda activa de casos,Acompañante"
                 style="radio" answerSeparator=""/>
        </div>
    </section>

    <!-- Subjective -->
    <ifMode mode="VIEW" include="false">
        <h1>
            <uimessage code="pihcore.subjective.title"/>
        </h1>
    </ifMode>
    <section id="subjective" sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="section-container">
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <uimessage code="pihcore.subjective.title"/>
                        <lookup expression="fn.latestObs('CIEL:1390').obsDatetime" />
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('CIEL:1390').valueText" />
                    </p>
                    <br/>
                    <p>
                        <uimessage code="pihcore.lab.lab_tests.title"/>
                        <lookup expression="fn.latestObs('PIH:11762').obsDatetime" />
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('PIH:11762').valueText" />
                    </p>
                </div>
                <div>
                    <obs conceptId="CIEL:1390" style="textarea" rows="6" id="presenting-history"/>
                </div>
            </div>
        </div>
    </section>

    <!-- Objective -->
    <ifMode mode="VIEW" include="false">
        <h1>
            <uimessage code="pihcore.visitNote.objective"/>
        </h1>
    </ifMode>

    <section id="objective" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.ncd.info">
        <div class="section-container">
            <label>
                <uimessage code="pihcore.ncd.category"/>
            </label>
            <label class="half-size-text">
                <uimessage code="pihcore.ncd.category.instructions"/>
            </label>

            <!-- The ordering of these corresponds to the Spanish alphebetization -->
            <enrollInProgram programId="Asthma" showCheckbox="true" toggle="asthma"/>
            <uimessage code="pihcore.ncd.asthma"/>
            <br />
            <enrollInProgram programId="Malnutrition" showCheckbox="true"/>
            <uimessage code="pihcore.ncd.malnutrition"/>
            <br />
            <span id="diabetes-enroll">
                <enrollInProgram programId="Diabetes" showCheckbox="true"/>
            </span>
            <uimessage code="pihcore.ncd.diabetes"/>
            <br />
            <enrollInProgram programId="Epilepsy" showCheckbox="true" toggle="epilepsy"/>
            <uimessage code="pihcore.ncd.epilepsy"/>
            <br />
            <span id="htn-enroll" >
                <enrollInProgram programId="Hypertension" showCheckbox="true" toggle="ProgramHEARTS"/>
            </span>
            <uimessage code="pihcore.ncd.htn"/>
            <br />
            <enrollInProgram programId="ANC" showCheckbox="true" toggle="anc"/>
            <uimessage code="pihcore.mch.anc"/>
            <br />
            <enrollInProgram programId="Mental Health" showCheckbox="true" toggle="mental"/>
            <uimessage code="pihcore.ncd.mental"/>
        </div>

    </section>

    <!-- Asthma -->
    <section id="asthma" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.ncd.asthma">
        <div class="question-container">
            <includeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) > 4">
                <label>
                    <uimessage code="pihcore.daytime_symptoms"/>
                </label>
                <div class="two-columns">
                    <div>
                        <lookup expression="fn.latestObs('PIH:Daytime asthma symptoms more than twice per week').obsDatetime" />
                        <lookup complexExpression="#if($fn.latestObs('PIH:Daytime asthma symptoms more than twice per week')) &#8194; &#8227; &#8194; #end" />
                        <lookup expression="fn.latestObs('PIH:Daytime asthma symptoms more than twice per week').valueCoded.name" />
                    </div>
                    <div>
                        <obs conceptId="PIH:Daytime asthma symptoms more than twice per week"
                             answerConceptIds="PIH:YES,PIH:NO"
                             style="radio" answerSeparator="" />
                    </div>
                </div>
            </includeIf>
            <excludeIf velocityTest="$patient.getAge($encounter.getEncounterDatetime()) > 4">
                <label>
                    <uimessage code="pihcore.daytime_symptoms_once"/>
                </label>
                <div class="two-columns">
                    <div>
                        <lookup expression="fn.latestObs('PIH:Daytime asthma symptoms for more than a few minutes more than once a week').obsDatetime" />
                        <lookup complexExpression="#if($fn.latestObs('PIH:Daytime asthma symptoms for more than a few minutes more than once a week')) &#8194; &#8227; &#8194; #end" />
                        <lookup expression="fn.latestObs('PIH:Daytime asthma symptoms for more than a few minutes more than once a week').valueCoded.name" />
                    </div>
                    <div>
                        <obs conceptId="PIH:Daytime asthma symptoms for more than a few minutes more than once a week"
                             answerConceptIds="PIH:YES,PIH:NO"
                             style="radio" answerSeparator="" />
                    </div>
                </div>
            </excludeIf>
        </div>

        <div class="question-container">
            <label>
                <uimessage code="pihcore.nighttime_symptoms"/>
            </label>
            <div class="two-columns">
                <div class="small-text">-</div>
                <div class="checkboxRadio">
                    <obsgroup groupingConceptId="PIH:FUNCTIONAL REVIEW OF SYMPTOMS CONSTRUCT">
                        <span class="two-columns">
                            <obs conceptIds="PIH:SYMPTOM PRESENT,PIH:SYMPTOM ABSENT" answerConceptId="CIEL:148273"
                                labelText="" conceptLabels="Sí,No" style="radio" answerSeparator="" />
                        </span>
                    </obsgroup>
                </div>
            </div>
        </div>
        <div class="question-container">
            <label><uimessage code="pihcore.meds_2x_wk"/></label>
            <div class="two-columns">
                <div>
                    <lookup expression="fn.latestObs('PIH:Medications more than twice per week').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:Medications more than twice per week')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:Medications more than twice per week').valueCoded.name" />
                </div>
                <div>
                    <obs conceptId="PIH:Medications more that twice per week"
                         answerConceptIds="PIH:YES,PIH:NO"
                         style="radio" answerSeparator="" />
                </div>
            </div>
        </div>
        <div class="question-container">
            <label><uimessage code="pihcore.limitation_of_activity"/></label>
            <div class="two-columns">
                <div>
                    <lookup expression="fn.latestObs('PIH:Limitation of ability to perform main daily activities coded').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:Limitation of ability to perform main daily activities coded')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:Limitation of ability to perform main daily activities coded').valueCoded.name" />
                </div>
                <div>
                    <obs conceptId="PIH:Limitation of ability to perform main daily activities coded"
                         answerConceptIds="PIH:YES,PIH:NO"
                         style="radio" answerSeparator=""/>
                </div>
            </div>
        </div>
    </section>

    <!-- Diabetes -->
    <section id="diabetes" sectionTag="fieldset" headerTag="legend" headerStyle="title"
             headerCode="pihcore.ncd.diabetes">
        <div class="question-container">
            <label><uimessage code="pihcore.lab.glucose"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <lookup expression="fn.latestObs('PIH:SERUM GLUCOSE').obsDatetime" />
                        <lookup complexExpression="#if($fn.latestObs('PIH:SERUM GLUCOSE')) &#8194; &#8227; &#8194; #end" />
                        <lookup expression="fn.latestObs('PIH:SERUM GLUCOSE').valueNumeric" />
                    </p>
                    <p>
                        <uimessage code="pihcore.lab.isFastingGlucose.title"/>:
                        <lookup expression="fn.latestObs('PIH:Fasting for blood glucose test').valueCoded.name" />
                    </p>
                </div>
                <div>
                    <obs id="glucose" class="small" conceptId="PIH:SERUM GLUCOSE" showUnits="true"/>
                    <label><uimessage code="pihcore.lab.isFastingGlucose.title"/></label>
                    <div class="inline-radio">
                        <obs id="fasting-for-glucose" conceptId="PIH:Fasting for blood glucose test"
                             answerConceptIds="PIH:YES,PIH:NO"
                             style="radio" answerSeparator="" />
                    </div>
                </div>
            </div>
        </div>
        <repeat>
            <template>
                <div class="question-container">
                    <label><uimessage code="{message}"/></label>
                    <div class="two-columns">
                        <div class="small-text">
                            <lookup expression="fn.latestObs('{concept}').obsDatetime" />
                            <lookup complexExpression="#if($fn.latestObs('{concept}')) &#8194; &#8227; &#8194; #end" />
                            <lookup expression="fn.latestObs('{concept}').valueNumeric" />
                        </div>
                        <div>
                            <obs class="small" conceptId="{concept}" showUnits="{showUnits}"/>
                        </div>
                    </div>
                </div>
            </template>
            <render message="pihcore.lab.hba1c" concept="PIH:HbA1c" showUnits="true"/>
            <render message="pihcore.lab.urinary_albumin" concept="PIH:URINARY ALBUMIN" showUnits="false" />
            <render message="pihcore.ncd.vitals.waist_cm" concept="CIEL:163080" showUnits="true" />
        </repeat>
        <div class="question-container">
            <label><uimessage code="pihcore.ncd.diabetes.foot_findings"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:FOOT EXAM FINDINGS').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:FOOT EXAM FINDINGS')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:FOOT EXAM FINDINGS').valueCoded.name" />
                </div>
                <div>
                    <obs conceptId="PIH:FOOT EXAM FINDINGS"
                         answerConceptIds="PIH:NOT DONE,PIH:NORMAL,PIH:FUNGAL INFECTION,PIH:KERATODERMA,PIH:FOOT ULCER" />
               </div>
            </div>
        </div>
        <repeat>
            <template>
                <div class="question-container">
                    <label><uimessage code="{message}"/></label>
                    <div class="two-columns">
                        <div class="small-text">
                            <lookup expression="fn.latestObs('{concept}').obsDatetime" />
                            <lookup complexExpression="#if($fn.latestObs('{concept}')) &#8194; &#8227; &#8194; #end" />
                            <lookup expression="fn.latestObs('{concept}').valueCoded.name" />
                        </div>
                        <div class="{obsDivClass}">
                            <obs conceptId="{concept}" style="radio" answerConceptIds="{answerConceptIds}"
                                 answerSeparator="{answerSeparator}"/>
                        </div>
                    </div>
                </div>
            </template>
            <render message="pihcore.ncd.diabetes.hypoglycemia_symptoms" concept="PIH:Hypoglycemia symptoms"
                    answerConceptIds="PIH:YES,PIH:NO"
                    obsDivClass="inline-radio" answerSeparator="&#8195;&#8195;"
            />
            <render message="pihcore.ncd.hx_alcohol_use" concept="PIH:HISTORY OF ALCOHOL USE"
                    answerConceptIds="PIH:IN THE PAST,PIH:CURRENTLY,PIH:NEVER,PIH:unknown"
                    obsDivClass="" answerSeparator=""
            />
            <render message="pihcore.ncd.hx_tobacco_use" concept="PIH:HISTORY OF TOBACCO USE"
                    answerConceptIds="PIH:IN THE PAST,PIH:CURRENTLY,PIH:NEVER,PIH:unknown"
                    obsDivClass="" answerSeparator=""
            />
        </repeat>
    </section>

    <script>
        jq(function() {
            setUpCholesterolSection();
        });
    </script>
    <section id="cholesterol" headerCode="pihcore.lab.cholesterol" sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="question-container">
            <label><uimessage code="pihcore.lab.total_chol"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:TOTAL CHOLESTEROL').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:TOTAL CHOLESTEROL')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:TOTAL CHOLESTEROL').valueNumeric" />
                </div>
                <div>
                    <obs id="chol" conceptId="PIH:TOTAL CHOLESTEROL" showUnits="true" class="small"/>
                </div>
            </div>
        </div>
        <div class="question-container">
            <label><uimessage code="pihcore.lab.hdl"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:HIGH-DENSITY LIPOPROTEIN CHOLESTEROL').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:HIGH-DENSITY LIPOPROTEIN CHOLESTEROL')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:HIGH-DENSITY LIPOPROTEIN CHOLESTEROL').valueNumeric" />
                </div>
                <div>
                    <obs id="ldl" conceptId="PIH:HIGH-DENSITY LIPOPROTEIN CHOLESTEROL" showUnits="true" class="small"/>
                </div>
            </div>
        </div>
        <div class="question-container">
            <label><uimessage code="pihcore.lab.ldl"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:LOW-DENSITY LIPOPROTEIN CHOLESTEROL').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:LOW-DENSITY LIPOPROTEIN CHOLESTEROL')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:LOW-DENSITY LIPOPROTEIN CHOLESTEROL').valueNumeric" />
                </div>
                <div>
                    <obs id="hdl" conceptId="PIH:LOW-DENSITY LIPOPROTEIN CHOLESTEROL" showUnits="true" class="small"/>
                </div>
            </div>
        </div>
    </section>

    <!-- Program HEARTS -->
    <section id="ProgramHEARTS" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerLabel="Programa HEARTS">
        <div class="question-container">
            <div class="two-columns">
                <div class="small-text">
                   
                    <p>HEARTS:</p>
                    <enrollInProgram programId="HEARTS" 
                                     showCheckbox="true" 
                                     toggle="FieldsHEARTS"/>               

                </div>

                <div class="FieldsHEARTS">
                    
                        <div class="small-text">
                            <p>Cambio de tratamiento por algoritmo:</p>
                            <obs
                                conceptId="PIH: 13705"
                                answerConceptIds="CIEL:1065, CIEL:1066"
                                style="radio"
                                answerSeparator="">
                            </obs>

                        </div>

                        <div class="small-text">
                            <p>Riesgo cardiovascular:</p>

                            <lookup expression="fn.latestObs('PIH:13703').valueNumeric"/>
                            <obs id="ldl" 
                                 conceptId="PIH:13703" 
                                 showUnits="false" 
                                 class="small"/>

                        </div>
                  
                </div>
            </div>
        </div>
    </section>


    <!-- Epilepsy -->
    <section id="epilepsy" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.ncd.epilepsy">
        <script>
            jq(function() {
                setUpEpilepsySection();
            });
        </script>

        <div class="question-container">
            <p>
                <uimessage code="pihcore.ncd.epilepsy.seizure_num_baseline"/>
                <span id="epi-baseline-last-obs" class="value">
                    <lookup expression="fn.latestObs('PIH:Number of seizures in one month before medications').valueNumeric" />
                </span>
            </p>
            <div>
                <button id="change-epi-baseline-button" type="button">
                    <uimessage code="pihcore.ncd.epilepsy.change_baseline" />
                </button>
            </div>
            <div id="epi-baseline-input">
                <obs id="epi-baseline" class="small" conceptId="PIH:Number of seizures in one month before medications"/>
            </div>
        </div>

        <div class="question-container">
            <label><uimessage code="pihcore.ncd.epilepsy.seizure_num_1mo"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:Number of seizures in the past month').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:Number of seizures in the past month')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:Number of seizures in the past month').valueNumeric" />
                </div>
                <div>
                    <obs id="seizure-num" class="small" conceptId="PIH:Number of seizures in the past month"/>
                </div>
            </div>
        </div>
        <div id="seizure-percent-reduction-container" class="question-container">
            <p>
                <span id="seizure-percent-reduction" class="value" />
                <uimessage code="pihcore.ncd.epilepsy.percent_reduction"/>
            </p>
        </div>
    </section>

    <!-- Maternal -->
    <section id="anc" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.mch.anc">

        <ifMode mode="VIEW" include="false" >
            <script type="text/javascript">
                jq(function () {
                    setUpMaternalSection(
                        '<lookup expression="encounter.getEncounterDatetime().getTime()"/>',
                        '<uimessage code="pihcore.weeks"/>'
                    );
                });
            </script>
        </ifMode>

        <!-- Last menstrual period (LMP or DDR) -->
        <div class="question-container">
            <label>
                <uimessage code="pihcore.pregnancy.lastPeriod"/>
            </label>
            <div class="two-columns">
                <div id="lmp-existing" class="small-text">
                    <lookup expression="fn.latestObs('CIEL:1427').valueDate"/>
                </div>
                <div class="medium">
                    <obs id="lastPeriodDate" conceptId="CIEL:1427" allowFutureDates="false"/>
                </div>
            </div>
        </div>
        <!-- G, P, C, A -->
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.grava"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:5624').valueNumeric"/>
                </div>
                <div class="small">
                    <obs conceptId="CIEL:5624" id="gravidaInput"/>
                </div>
            </div>
        </div>
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.para"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:1053').valueNumeric"/>
                </div>
                <div class="small">
                    <obs conceptId="CIEL:1053" />
                </div>
            </div>
        </div>
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.cesarian"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:160081').valueNumeric"/>
                </div>
                <div class="small">
                    <obs conceptId="CIEL:160081" />
                </div>
            </div>
        </div>
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.abortus"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:1823').valueNumeric"/>
                </div>
                <div class="small">
                    <obs conceptId="CIEL:1823" />
                </div>
            </div>
        </div>

        <div class="question-container">
            <label><uimessage code="pihcore.mch.ultrasoundResultText"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <!-- This doesn't work, but I'd like it to. See https://issues.openmrs.org/browse/RC-35 -->
                        <!-- <lookup complexExpression="#foreach($obs in $fn.allObs('PIH:7018')) $obs.obsDatetime #end"/> -->
                        <lookup expression="fn.latestObs('PIH:7018').obsDatetime"/>
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('PIH:7018').valueText"/>
                    </p>
                </div>
                <div>
                    <obs conceptId="PIH:7018" style="textarea" rows="4"/>
                </div>
            </div>
        </div>

        <!-- HIV & Syphalis tests -->
        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.hivTest"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:163722').obsDatetime"/>
                </div>
                <div>
                    <obs conceptId="CIEL:163722" answerConceptId="CIEL:1065"
                         style="checkbox" />
                </div>
            </div>
        </div>
        <div class="question-container">
            <label>
                <uimessage code="pihcore.lab.vdrl"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('CIEL:299').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('CIEL:299')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('CIEL:299').valueCoded.name" />
                </div>
                <div>
                    <obs conceptId="CIEL:299"
                         answerConceptIds="CIEL:703,CIEL:664"
                         style="radio" answerSeparator="" />
                </div>
            </div>
        </div>

        <div class="question-container">
            <label>
                <uimessage code="pihcore.lab.hemoglobin"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <!-- See https://issues.openmrs.org/browse/RC-35 -->
                    <lookup complexExpression="#foreach($obs in $fn.allObs('CIEL:21')) $obs.valueNumeric — $obs.obsDatetime #end"/>
                </div>
                <div>
                    <obs class="small" conceptId="CIEL:21" showUnits="true" />
                </div>
            </div>
        </div>

        <div class="question-container">
            <label><uimessage code="pihcore.lab.urinary_albumin"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:URINARY ALBUMIN').obsDatetime" />
                    <lookup complexExpression="#if($fn.latestObs('PIH:URINARY ALBUMIN')) &#8194; &#8227; &#8194; #end" />
                    <lookup expression="fn.latestObs('PIH:URINARY ALBUMIN').valueNumeric" />
                </div>
                <div>
                    <obs class="small" conceptId="PIH:URINARY ALBUMIN" />
                </div>
            </div>
        </div>

        <div class="question-container">
            <label>
                <uimessage code="pihcore.lab.blood_type"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:BLOOD TYPING').valueCoded.name"/>
                </div>
                <div>
                    <div class="inline-radio" >
                        <obs conceptId="PIH:BLOOD TYPING"
                             answerConceptIds="CIEL:690,CIEL:692,CIEL:694,CIEL:696,CIEL:699,CIEL:701,CIEL:1230,CIEL:1231,PIH:unknown"/>
                    </div>
                </div>
            </div>
        </div>

        <div class="question-container">
            <label>
                <uimessage code="pihcore.mch.dtpGiven"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <!-- See https://issues.openmrs.org/browse/RC-35 -->
                    <lookup complexExpression="#foreach($obs in $fn.allObs('CIEL:984')) $obs.valueCoded.getShortNames() — $obs.obsDatetime #end"/>
                </div>
                <div>
                    <obs conceptId="CIEL:984" answerConceptId="CIEL:781" answerCode="Sí"/>
                </div>
            </div>
        </div>


        <div class="question-container">
            <label>
                <uimessage code="pihcore.lab.glucoseTolerance"/>
            </label>
            <div class="two-columns">
                <div class="small-text">
                    <!-- See https://issues.openmrs.org/browse/RC-35 -->
                    <lookup complexExpression="#foreach($obs in $fn.allObs('PIH:12051')) $obs.valueCoded.name — $obs.obsDatetime #end"/>
                </div>
                <div>
                    <obs conceptId="PIH:12051"
                         answerConceptIds="CIEL:1228,CIEL:1229"
                         answerCodes="pihcore.reactive,pihcore.nonreactive"
                         style="radio" answerSeparator="" />
                </div>
            </div>
        </div>

        <div id="calculated-edd-and-gestational" class="question-container hidden">
            <div id="calculated-gestational-age-wrapper">
                <span id="calculated-gestational-age-label">
                    <uimessage code="pihcore.calculatedGestationalAge"/>:&#160;
                </span>
                <span id='calculated-gestational-age-value' class="value"></span>
            </div>
            <div id="calculated-edd-wrapper">
                <span id="calculated-edd-label">
                    <uimessage code="pihcore.calculatedEstimatedDeliveryDate"/>:&#160;
                </span>
                <span id='calculated-edd' class="value"></span>
            </div>
        </div>

        <div class="question-container">
            <label><uimessage code="pihcore.mch.birthPlan"/></label>
            <div class="two-columns">
                <div class="small-text">
                    <lookup expression="fn.latestObs('PIH:BIRTH PLAN').valueText" />
                </div>
                <div>
                    <obs conceptId="PIH:BIRTH PLAN" style="textarea" rows="4"/>
                </div>
            </div>
        </div>

    </section>

    <!-- Mental -->
    <section id="mental" sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.ncd.mental">
        <div class="question-container">
            <div class="two-columns">
                <div>
                    <label>
                        <uimessage code="pihcore.ncd.mental.phq9Score"/>
                    </label>
                    <br />
                    <div class="small-text">
                        <p>
                            <lookup expression="fn.latestObs('CIEL:165137').obsDatetime" />
                            <lookup complexExpression="#if($fn.latestObs('CIEL:165137')) &#8194; &#8227; &#8194; #end" />
                            <lookup expression="fn.latestObs('CIEL:165137').valueNumeric" />
                        </p>
                    </div>
                </div>
                <div>
                    <div>
                        <a href="/openmrs/ms/uiframework/resource/file/configuration/pih/images/PHQ9-2018.pdf"
                           target="_blank" rel="noopener noreferrer">
                            <uimessage code="pihcore.ncd.mental.phq9FormLink" />
                        </a>
                    </div>
                    <div class="small">
                        <obs conceptId="CIEL:165137"/>
                    </div>
                </div>
            </div>
        </div>
        <div class="question-container">
            <div class="two-columns">
                <div>
                    <label><uimessage code="pihcore.ncd.mental.gad7Score"/></label>
                    <br />
                    <div class="small-text">
                        <p>
                            <lookup expression="fn.latestObs('CIEL:165185').obsDatetime" />
                            <lookup complexExpression="#if($fn.latestObs('CIEL:165185')) &#8194; &#8227; &#8194; #end" />
                            <lookup expression="fn.latestObs('CIEL:165185').valueNumeric" />
                        </p>
                    </div>
                </div>
                <div>
                    <div>
                        <a href="/openmrs/ms/uiframework/resource/file/configuration/pih/images/GAD7-CESPDF.pdf"
                           target="_blank" rel="noopener noreferrer">
                            <uimessage code="pihcore.ncd.mental.gad7FormLink" />
                        </a>
                    </div>
                    <div class="small">
                        <obs conceptId="CIEL:165185"/>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="pihcore.exam.title" >
        <div class="section-container">
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <lookup expression="fn.latestObs('CIEL:1391').obsDatetime" />
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('CIEL:1391').valueText" />
                    </p>
                </div>
                <div>
                    <obs conceptId="CIEL:1391" style="textarea" rows="5"/>
                </div>
            </div>
        </div>
    </section>

    <!-- Prevencion de control de infecciones -->
     <section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Prevención de control de infecciones">
      <!-- TB -->
        <div class="section-container">
            <div class="two-columns">
                <div class="small-text">
                    <p>Sospecha de tuberculosis:</p>
                    <obs id="SuspectedTB"
                        conceptId="PIH:Is TB suspected"
                        answerConceptIds="CIEL:1065, CIEL:1066"
                        style="radio"
                        answerSeparator="">

                        <controls>
                            <when value="CIEL:1065" thenDisplay="#OptionsTB"/>
                        </controls>
                   </obs>

                </div>
                <div id="OptionsTB">

                    <p>Resultado de prueba:</p>
                    <obs conceptId="PIH:Tuberculosis culture result"
                         answerConceptIds="PIH:NOT DONE,PIH:NEGATIVE,PIH:POSITIVE"
                         style="radio"
                         answerSeparator=""/>
                    <br/>

                    <obs conceptId="PIH:Suspected TB free-text notes"
                         style="textarea"
                         labelText="Observaciones:"
                         rows="5"/>

                </div>
            </div>
        </div>

        <!-- VIH -->
        <div class="section-container">
            <div class="two-columns">
                <div class="small-text">

                    <p>Sospecha de VIH:</p>
                    <obs id="SuspectedVIH"
                        conceptId="PIH:Is HIV suspected"
                        answerConceptIds="CIEL:1065, CIEL:1066"
                        style="radio"
                        answerSeparator="">

                        <controls>
                            <when value="CIEL:1065" thenDisplay="#OptionsVIH"/>
                        </controls>
                   </obs>

                </div>
                <div id="OptionsVIH">

                    <p>Resultado de prueba:</p>
                    <obs conceptId="PIH:RESULT OF HIV TEST"
                         answerConceptIds="PIH:NOT DONE,PIH:NEGATIVE,PIH:POSITIVE"
                         style="radio"
                         answerSeparator=""/>
                    <br/>

                    <obs conceptId="PIH:Suspected HIV free-text notes"
                         style="textarea"
                         labelText="Observaciones:"
                         rows="5"/>

                </div>
            </div>
        </div>

        <!-- COVID -->
        <div class="section-container">
            <div class="tres-columns">
                <div class="small-text">

                    <p>Sospecha de Covid-19:</p>
                    <obs id="SuspectedCOVID-19"
                        conceptId="PIH:Is COVID suspected"
                        answerConceptIds="CIEL:1065, CIEL:1066"
                        style="radio"
                        answerSeparator="">

                        <controls>
                            <when value="CIEL:1065" thenDisplay="#TipoPruebaCovid"/>
                        </controls>
                   </obs>

                </div>

                <div id="TipoPruebaCovid">

                   <p>Tipo de prueba:</p>
                   <obs id="whattype"
                        conceptId="PIH:Type of COVID test"
                        answerConceptIds="CIEL:165840,CIEL:165853,CIEL:165852"
                        answerLabels="PCR,Anticuerpos,Antigeno"
                        style="radio"
                        answerSeparator="">

                        <controls>
                            <when value="CIEL:165840" thenDisplay="#OptionsPCR"/>
                            <when value="CIEL:165853" thenDisplay="#OptionsAnticuerpos"/>
                            <when value="CIEL:165852" thenDisplay="#OptionsAntigeno"/>
                        </controls>
                   </obs>
                   <br/>

                   <obs conceptId="PIH:Suspected TB free-text notes"
                        style="textarea"
                        labelText="Observaciones:"
                        rows="5"/>
                   <br/>

                </div>

                <div id="OptionsPCR">

                    <p>Resultado PCR:</p>
                    <obs conceptId="CIEL:165840"
                         answerConceptIds="PIH:POSITIVE,PIH:NEGATIVE"
                         style="radio"
                         answerSeparator=""/>
                </div>

                <div id="OptionsAnticuerpos">

                    <p>Resultado anticuerpos:</p>
                    <obs conceptId="CIEL:165853"
                         answerConceptIds="PIH:POSITIVE,PIH:NEGATIVE"
                         style="radio"
                         answerSeparator=""/>
                </div>

                <div id="OptionsAntigeno">

                    <p>Resultado antigeno:</p>
                    <obs conceptId="CIEL:165852"
                         answerConceptIds="PIH:POSITIVE,PIH:NEGATIVE"
                         style="radio"
                         answerSeparator=""/>
                </div>
            </div>
        </div>
    </section>


    <!-- Analysis -->
    <ifMode mode="VIEW" include="false">
        <h1>
            <uimessage code="pihcore.visitNote.analysis"/>
        </h1>
    </ifMode>

    <section sectionTag="fieldset" headerTag="legend" headerStyle="title">
        <div class="section-container">
            <div class="two-columns">
                <div class="small-text">
                    <p>
                        <lookup expression="fn.latestObs('PIH:CLINICAL IMPRESSION COMMENTS').obsDatetime" />
                    </p>
                    <p>
                        <lookup expression="fn.latestObs('PIH:CLINICAL IMPRESSION COMMENTS').valueText" />
                    </p>
                </div>
                <div>
                    <obs conceptId="PIH:CLINICAL IMPRESSION COMMENTS" style="textarea" rows="5"/>
                </div>
            </div>
        </div>
        <div class="question-container">
            <div id="diagnosis-lookup">
                <encounterDiagnosesByObs selectedDiagnosesTarget="#encounter-diagnoses-target"/>
            </div>
            <div id="encounter-diagnoses-target">
            </div>
        </div>
    </section>

    <!-- Plan -->
    <div id="section-plan">
        <ifMode mode="VIEW" include="false">
            <script type="text/javascript">
                jq(function() {
                    setUpPlanSection(
                        '<uimessage code="pihcore.visitNote.plan.medications.error.noMedication"/>',
                        '<uimessage code="pihcore.visitNote.plan.medications.error.noDoseUnits"/>',
                        '<uimessage code="pihcore.visitNote.plan.medications.error.noDose"/>',
                        '<uimessage code="pihcore.visitNote.plan.medications.error.noDurationUnits"/>',
                        '<uimessage code="pihcore.visitNote.plan.medications.error.noDuration"/>'
                    );
                    setUpExpandableSection('medication');
                });
            </script>
        </ifMode>

        <ifMode mode="VIEW" include="false">
            <h1>
                <uimessage code="pihcore.visitNote.plan"/>
            </h1>
        </ifMode>

        <section id="clinical-management-plan" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.consult.clinicalManagementPlan">
            <div class="section-container">
                <div class="two-columns">
                    <div class="small-text">
                        <p>
                            <lookup expression="fn.latestObs('CIEL:162749').obsDatetime" />
                        </p>
                        <p>
                            <lookup expression="fn.latestObs('CIEL:162749').valueText" />
                        </p>
                    </div>
                    <div>
                        <obs conceptId="CIEL:162749" style="textarea" rows="5" id="clinical-management-plan"/>
                    </div>
                </div>
            </div>
        </section>

        <section id="test-orders" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.lab.lab_tests.title">
            <div class="section-container">
                <p>
                    <obs conceptId="PIH:11762" style="textarea" rows="5" id="test-orders"/>
                </p>
            </div>
        </section>

        <section id="drug-orders" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="pihcore.ncd.meds">
            <div class="section-container">
                <repeat with="['1'],['2'],['3'],['4'],['5'],['6'],['7'],['8'],['9'],['10'],['11'],['12']">
                    <span id="medication-{0}" class="medication">
                        <obsgroup groupingConceptId="PIH:9070" showIfEmpty="false">
                            <h3>
                                <uimessage code="mirebalais.dispensing.medication"/>
                                {0}
                            </h3>
                            <fieldset class="medication">
                                <p class="field-error" style="display:none"></p>
                                <p>
                                    <label>
                                        <uimessage code="mirebalais.dispensing.medicationName"/>
                                    </label>
                                    <obs id="name{0}" class="medication-name" conceptId="CIEL:1282"
                                         answerDrugs="true" includeRetiredDrugs="false"/>
                                </p>
                                <p class="inline">
                                    <label>
                                        <uimessage code="mirebalais.dispensing.medicationAmount"/>
                                    </label>
                                    <obs id="amount{0}" conceptId="PIH:9071"/>
                                </p>
                                <p>
                                    <label>
                                        <uimessage code="mirebalais.dispensing.medicationInstructions"/>
                                    </label>
                                    <obs id="instructions{0}" class="medication-instructions" conceptId="PIH:9072"/>
                                </p>
                            </fieldset>
                        </obsgroup>
                    </span>
                </repeat>

                <button id="show-less-medication" type="button">
                    -
                </button>
                <button id="show-more-medication" type="button">
                    +
                </button>
            </div>

        </section>

        <section id="disposition-section" sectionTag="fieldset" headerTag="legend" headerStyle="title"
                 headerCode="coreapps.consult.disposition">

            <div class="section-container">

                <p id="return-date">
                    <label>
                        <uimessage code="pihcore.visitNote.plan.approximateReturnVisitDate"/>
                    </label>
                    <span class="medium">
                        <obs conceptId="PIH:RETURN VISIT DATE" allowFutureDates="true" id="apptDate"/>
                    </span>
                </p>

            </div>

        </section>

    </div>  <!-- section-plan -->

    <!-- Print prescription -->
    <div class="section-button">
        <button onclick="printPrescription()" type="button">
            <uimessage code="pihcore.visitNote.printPrescriptions" />
        </button>
    </div>
    <br/>
    <ifMode mode="VIEW" include="false">
        <div id="buttons">
            <submit submitClass="confirm right" submitCode="mirebalais.save"/>
            <button type="button" class="cancel">
                <uimessage code="emr.cancel"/>
            </button>
        </div>
    </ifMode>

</htmlform>
